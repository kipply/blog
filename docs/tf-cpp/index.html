<!DOCTYPE html>
<html lang="en" >
<link rel="stylesheet" href="/personal_site/themes/purple.css">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="no-referrer">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>Tensorflow Serving Client with C++ and Bazel | blog</title>
<meta property="og:title" content="Tensorflow Serving Client with C++ and Bazel | blog" />
<meta name="twitter:title" content="Tensorflow Serving Client with C++ and Bazel | blog" />

  <meta name="description" content="kipply&#x27;s blog about stuff she does or reads about or observes">
  <meta property="og:description" content="kipply&#x27;s blog about stuff she does or reads about or observes">
  <meta name="twitter:description" content="kipply&#x27;s blog about stuff she does or reads about or observes">

  <meta property="og:site_name" content="blog" />
  <meta property="og:url" content="&#x2F;personal_site" />

  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
        
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
            onload="renderMathInElement(document.body);"></script>
        
    
  

  <script type="text/javascript">
  let fetchStyle = function() {
    const themes = ['blue', 'cyan', 'deeppurple', 'green', 'indigo', 'lightblue', 'lightgreen', 'pink', 'purple', 'teal'];
    const theme = "/personal_site/themes/" + themes[Math.floor(Math.random() * themes.length)] + ".css";

    let link = document.createElement('link');
    link.type = 'text/css';
    link.rel = 'stylesheet';
    link.onload = function() {
      document.documentElement.setAttribute("style", "display:auto");
     };
    link.href = theme;

    let headScript = document.querySelector('script');
    headScript.parentNode.insertBefore(link, headScript);
  }
  fetchStyle()
  </script>

  <link rel='icon' type='image/x-icon' href="/personal_site/favicon.ico" />

  

  

</head>
<body>
  <header class="header">
    <h1 class="title-link"><a href="&#x2F;personal_site" class="p-title__link">blog</a></h1>
    <div class="header-links">
      <a href="https://carolchen.me"> Personal Site </a> |
      <a href="https://twitter.com/kipperrii"> Twitter </a> |
      <a href="https://github.com/kipply"> Github </a> |
      <a href="mailto:hello@carolchen.me"> Email </a>
    </div>
  </header>

  <main id="main" class="main">
    
<header>
  <h1>Tensorflow Serving Client with C++ and Bazel</h1>
  <div>
    <div class="article-meta">
      <time datetime="2022-02-25">
        2022-02-25
      </time>
      
      (4 min read)
    </div>
  </div>
</header>
<article class="article">
  <div class="page-body">
    <section id="js-article" class="article-body">
      
<blockquote>
<p>All code examples can be found in <a href="https://github.com/kipply/tf-serving-cpp">this repo</a>. If you know what you're looking for and can extract the value you need from that repository, the following post may be pretty useless.</p>
</blockquote>
<p>Tensorflow doesn't yet have support for TF Serving clients. For Golang, I opted to <a href="https://carolchen.me/blog/technical/tf-go/">compile the protobufs once and put the generated client in the codebase</a>. For a Bazel C++ project, I had two other reasonable options. One was to build tensorflow/serving with my project and use the build target that tensorflow set up for me. I tried that (as another blog post on the internet recommended) and bad things happened. For one, tensorflow/serving relies on tensorflow/tensorflow which has a whole bunch of shit going on (namely long build times) and dependencies on parts of cuda. And two, they had dependencies that clashed with some of the other items in my <code>WORKSPACE</code> and it seems that they might still rely on bazel 3.7.0 and I would like to use 5.0.0. So I went with the copy the protos in your project then do the build (which someone else did <a href="https://github.com/andrew-k-21-12/tf-serving-client-cpp">for CMake</a>).</p>
<p>Reference Links: <a href="https://grpc.io/">gRPC</a> || <a href="https://developers.google.com/protocol-buffers/docs/cpptutorial">Protocol Buffers C++</a> || <a href="https://www.tensorflow.org/tfx/serving/serving_basic">Tensorflow Serving</a> || <a href="https://docs.bazel.build/versions/main/be/protocol-buffer.html">Bazel Protocol Buffer Rules</a></p>
<h3 id="copy-pasting-the-protos">Copy Pasting the Protos</h3>
<p>You don't need to copy all of the protos in tensorflow/serving and certainly not in tensor/tensorflow as you probably only plan on using the <code>PredictionService</code> (as opposed to classify or regress, in which case you'll have to do some of your own proto copying).</p>
<p>Otherwise, these protos can be downloaded from the <a href="https://github.com/kipply/tf-serving-cpp">git repo here</a>, and they're up to date as of tensorflow/serving version 2.8.0 and are very unlikely to change in breaking ways in the near future.</p>
<p>If you put them in a different folder, you'll probably need to rename the imports in the <code>.proto</code> files.</p>
<h3 id="starlark-star-bright-first-star-i-see-tonight">Starlark, star bright, first star I see tonight</h3>
<p>The protos don't build themselves, and the compilation setup is 200 lines of Starlark (I'm doing ok here, tensorflow/serving uses 450 lines). copy them <a href="https://raw.githubusercontent.com/kipply/tf-serving-cpp/main/BUILD">here</a> and leave out the last ten lines that builds a main file.</p>
<p>In your <code>WORKSPACE</code> file you'll want the following;</p>
<pre data-lang="python" style="background-color:#282a36;color:#f8f8f2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#50fa7b;">load</span><span>(</span><span style="color:#f1fa8c;">&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;</span><span>, </span><span style="color:#f1fa8c;">&quot;http_archive&quot;</span><span>)
</span><span>
</span><span style="color:#6272a4;">#
</span><span style="color:#6272a4;"># GRPC Dependencies
</span><span style="color:#6272a4;">#
</span><span style="color:#50fa7b;">http_archive</span><span>(
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">name </span><span style="color:#ff79c6;">= </span><span style="color:#f1fa8c;">&quot;com_github_grpc_grpc&quot;</span><span>,
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">strip_prefix </span><span style="color:#ff79c6;">= </span><span style="color:#f1fa8c;">&quot;grpc-dc78581af30da834b7b95572f109bf6c708686e0&quot;</span><span>,
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">urls </span><span style="color:#ff79c6;">= </span><span>[
</span><span>        </span><span style="color:#f1fa8c;">&quot;https://github.com/grpc/grpc/archive/dc78581af30da834b7b95572f109bf6c708686e0.tar.gz&quot;</span><span>,
</span><span>    ],
</span><span>)
</span><span>
</span><span style="color:#50fa7b;">load</span><span>(</span><span style="color:#f1fa8c;">&quot;@com_github_grpc_grpc//bazel:grpc_deps.bzl&quot;</span><span>, </span><span style="color:#f1fa8c;">&quot;grpc_deps&quot;</span><span>)
</span><span>
</span><span style="color:#50fa7b;">grpc_deps</span><span>()
</span><span>
</span><span style="color:#50fa7b;">load</span><span>(</span><span style="color:#f1fa8c;">&quot;@com_github_grpc_grpc//bazel:grpc_extra_deps.bzl&quot;</span><span>, </span><span style="color:#f1fa8c;">&quot;grpc_extra_deps&quot;</span><span>)
</span><span>
</span><span style="color:#50fa7b;">grpc_extra_deps</span><span>()
</span><span>
</span><span style="color:#6272a4;">#
</span><span style="color:#6272a4;"># Protocol buffer rules
</span><span style="color:#6272a4;">#
</span><span style="color:#50fa7b;">http_archive</span><span>(
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">name </span><span style="color:#ff79c6;">= </span><span style="color:#f1fa8c;">&quot;rules_proto&quot;</span><span>,
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">sha256 </span><span style="color:#ff79c6;">= </span><span style="color:#f1fa8c;">&quot;66bfdf8782796239d3875d37e7de19b1d94301e8972b3cbd2446b332429b4df1&quot;</span><span>,
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">strip_prefix </span><span style="color:#ff79c6;">= </span><span style="color:#f1fa8c;">&quot;rules_proto-4.0.0&quot;</span><span>,
</span><span>    </span><span style="font-style:italic;color:#ffb86c;">urls </span><span style="color:#ff79c6;">= </span><span>[
</span><span>        </span><span style="color:#f1fa8c;">&quot;https://mirror.bazel.build/github.com/bazelbuild/rules_proto/archive/refs/tags/4.0.0.tar.gz&quot;</span><span>,
</span><span>        </span><span style="color:#f1fa8c;">&quot;https://github.com/bazelbuild/rules_proto/archive/refs/tags/4.0.0.tar.gz&quot;</span><span>,
</span><span>    ],
</span><span>)
</span><span>
</span><span style="color:#50fa7b;">load</span><span>(</span><span style="color:#f1fa8c;">&quot;@rules_proto//proto:repositories.bzl&quot;</span><span>, </span><span style="color:#f1fa8c;">&quot;rules_proto_dependencies&quot;</span><span>, </span><span style="color:#f1fa8c;">&quot;rules_proto_toolchains&quot;</span><span>)
</span><span>
</span><span style="color:#50fa7b;">rules_proto_dependencies</span><span>()
</span><span>
</span><span style="color:#50fa7b;">rules_proto_toolchains</span><span>()
</span></code></pre>
<h3 id="tf-serving-client-over-grpc">TF Serving Client over GRPC</h3>
<p>I'll leave an example here, but be prepared to reference the C++ GRPC documentation a lot. I personally found it easier to read the header files, Google is quite diligent in leaving lots of comments in there though is not good at turning up the right reference documentation when you search for things.</p>
<pre data-lang="c++" style="background-color:#282a36;color:#f8f8f2;" class="language-c++ "><code class="language-c++" data-lang="c++"><span style="color:#ff79c6;">#include </span><span style="color:#f1fa8c;">&quot;grpcpp/grpcpp.h&quot;
</span><span style="color:#ff79c6;">#include </span><span style="color:#f1fa8c;">&quot;tensorflow_serving/apis/prediction_service.grpc.pb.h&quot;
</span><span>
</span><span style="font-style:italic;color:#8be9fd;">int </span><span style="color:#50fa7b;">main</span><span>(</span><span style="font-style:italic;color:#8be9fd;">int </span><span style="font-style:italic;color:#ffb86c;">argc</span><span>, </span><span style="font-style:italic;color:#8be9fd;">char</span><span style="color:#ff79c6;">** </span><span style="font-style:italic;color:#ffb86c;">argv</span><span>) </span><span style="color:#ffffff;">{
</span><span>  </span><span style="color:#ff79c6;">const </span><span style="font-style:italic;color:#8be9fd;">auto</span><span style="color:#ff79c6;">&amp;</span><span> prediction_service_stub </span><span style="color:#ff79c6;">=
</span><span>      tensorflow</span><span style="color:#ff79c6;">::</span><span>serving</span><span style="color:#ff79c6;">::</span><span>PredictionService</span><span style="color:#ff79c6;">::</span><span style="color:#50fa7b;">NewStub</span><span>(grpc</span><span style="color:#ff79c6;">::</span><span style="color:#50fa7b;">CreateChannel</span><span>(
</span><span>          </span><span style="color:#f1fa8c;">&quot;localhost:9000&quot;</span><span>, grpc</span><span style="color:#ff79c6;">::</span><span style="color:#50fa7b;">InsecureChannelCredentials</span><span>())); </span><span style="color:#6272a4;">// make sure your server is running here!
</span><span>
</span><span>  grpc</span><span style="color:#ff79c6;">::</span><span>ClientContext client_context;
</span><span>  tensorflow</span><span style="color:#ff79c6;">::</span><span>serving</span><span style="color:#ff79c6;">::</span><span>PredictRequest predict_request;
</span><span>  tensorflow</span><span style="color:#ff79c6;">::</span><span>serving</span><span style="color:#ff79c6;">::</span><span>PredictResponse predict_response;
</span><span>  grpc</span><span style="color:#ff79c6;">::</span><span>ClientContext cli_context;
</span><span>
</span><span>  predict_request</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">mutable_model_spec</span><span>()</span><span style="color:#ff79c6;">-&gt;</span><span style="color:#50fa7b;">set_name</span><span>(</span><span style="color:#f1fa8c;">&quot;model_name&quot;</span><span>); </span><span style="color:#6272a4;">// specify your model name here
</span><span>  predict_request</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">mutable_model_spec</span><span>()</span><span style="color:#ff79c6;">-&gt;</span><span style="color:#50fa7b;">set_signature_name</span><span>(</span><span style="color:#f1fa8c;">&quot;some_signature&quot;</span><span>); </span><span style="color:#6272a4;">// specify the signature here
</span><span>  google</span><span style="color:#ff79c6;">::</span><span>protobuf</span><span style="color:#ff79c6;">::</span><span>Map&lt;std</span><span style="color:#ff79c6;">::</span><span>string, tensorflow</span><span style="color:#ff79c6;">::</span><span>TensorProto&gt;</span><span style="color:#ff79c6;">&amp;</span><span> inputs </span><span style="color:#ff79c6;">=
</span><span>      </span><span style="color:#ff79c6;">*</span><span>predict_request</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">mutable_inputs</span><span>();
</span><span>
</span><span>  tensorflow</span><span style="color:#ff79c6;">::</span><span>TensorProto input_tensor;
</span><span>  input_tensor</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">set_dtype</span><span>(tensorflow</span><span style="color:#ff79c6;">::</span><span>DataType</span><span style="color:#ff79c6;">::</span><span>DT_INT32);
</span><span>  input_tensor</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">mutable_tensor_shape</span><span>()</span><span style="color:#ff79c6;">-&gt;</span><span style="color:#50fa7b;">add_dim</span><span>()</span><span style="color:#ff79c6;">-&gt;</span><span style="color:#50fa7b;">set_size</span><span>(</span><span style="color:#bd93f9;">2</span><span>);
</span><span>  input_tensor</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">add_int_val</span><span>(</span><span style="color:#bd93f9;">1</span><span>);
</span><span>  input_tensor</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">add_int_val</span><span>(</span><span style="color:#bd93f9;">2</span><span>);
</span><span>  inputs</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">insert</span><span>(</span><span style="color:#ffffff;">{</span><span style="color:#f1fa8c;">&quot;input_key&quot;</span><span>, input_tensor</span><span style="color:#ffffff;">}</span><span>);
</span><span>
</span><span>  </span><span style="color:#ff79c6;">const</span><span> grpc</span><span style="color:#ff79c6;">::</span><span>Status</span><span style="color:#ff79c6;">&amp;</span><span> predict_status </span><span style="color:#ff79c6;">=</span><span> prediction_service_stub</span><span style="color:#ff79c6;">-&gt;</span><span style="color:#50fa7b;">Predict</span><span>(
</span><span>      </span><span style="color:#ff79c6;">&amp;</span><span>cli_context, predict_request, </span><span style="color:#ff79c6;">&amp;</span><span>predict_response);
</span><span>
</span><span>  </span><span style="color:#ff79c6;">if </span><span>(</span><span style="color:#ff79c6;">!</span><span>predict_status</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">ok</span><span>()) </span><span style="color:#ffffff;">{
</span><span>    std</span><span style="color:#ff79c6;">::</span><span>cerr </span><span style="color:#ff79c6;">&lt;&lt;</span><span> predict_status</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">error_message</span><span>() </span><span style="color:#ff79c6;">&lt;&lt;</span><span> std</span><span style="color:#ff79c6;">::</span><span>endl;
</span><span>    </span><span style="color:#ff79c6;">return -</span><span style="color:#bd93f9;">1</span><span>;
</span><span>  </span><span style="color:#ffffff;">}
</span><span>
</span><span>  </span><span style="color:#ff79c6;">for </span><span>(</span><span style="color:#ff79c6;">const </span><span style="font-style:italic;color:#8be9fd;">auto</span><span style="color:#ff79c6;">&amp;</span><span> output_pair </span><span style="color:#ff79c6;">:</span><span> predict_response</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">outputs</span><span>()) </span><span style="color:#ffffff;">{
</span><span>    std</span><span style="color:#ff79c6;">::</span><span>cout </span><span style="color:#ff79c6;">&lt;&lt; </span><span style="color:#f1fa8c;">&quot;Output &quot; </span><span style="color:#ff79c6;">&lt;&lt;</span><span> output_pair</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">first </span><span style="color:#ff79c6;">&lt;&lt;</span><span> std</span><span style="color:#ff79c6;">::</span><span>endl;
</span><span>    </span><span style="font-style:italic;color:#8be9fd;">auto</span><span> tensor </span><span style="color:#ff79c6;">=</span><span> output_pair</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">second</span><span>;
</span><span>
</span><span>    </span><span style="color:#ff79c6;">for </span><span>(</span><span style="color:#ff79c6;">const </span><span style="font-style:italic;color:#8be9fd;">auto</span><span> val </span><span style="color:#ff79c6;">:</span><span> tensor</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">int_val</span><span>()) </span><span style="color:#ffffff;">{
</span><span>      std</span><span style="color:#ff79c6;">::</span><span>cout </span><span style="color:#ff79c6;">&lt;&lt; </span><span style="color:#f1fa8c;">&quot;</span><span style="color:#ff79c6;">\t</span><span style="color:#f1fa8c;">&quot; </span><span style="color:#ff79c6;">&lt;&lt;</span><span> val;
</span><span>    </span><span style="color:#ffffff;">}
</span><span>    std</span><span style="color:#ff79c6;">::</span><span>cout </span><span style="color:#ff79c6;">&lt;&lt;</span><span> std</span><span style="color:#ff79c6;">::</span><span>endl;
</span><span>  </span><span style="color:#ffffff;">}
</span><span style="color:#ffffff;">}
</span></code></pre>
<p>A thing about tensorflow/serving is that you specify dimensions, and you don't model your data as any kind of multi-dimensional tensor. Instead you just <code>add_dtype_val</code> until you've filled your specified dimensions. <a href="https://github.com/kipply/tf-serving-cpp/blob/main/main.cc">Here is the link to the full script</a> which also contains an example to get metadata from tensorflow/serving and is executable in bazel with <code>bazel run :main_lib</code>.</p>


    </section>
  </div>
</article>


<footer>
  <div class="social-icons">
    ---
    <br/>
    Thanks for reading <3
    <br/>
    I'm generally open to being contacted, find/contact me via:
    <a class="icon-link" href="https://twitter.com/kipperrii">
      <i class="fab fa-twitter"></i>
    </a>
    <a class="icon-link" href="https://github.com/kipply">
      <i class="fab fa-github"></i>
    </a>
    <a class="icon-link" href="https://www.instagram.com/kipperrii/">
      <i class="fab fa-instagram"></i>
    </a>
    <a class="icon-link" href="mailto:hello@carolchen.me">
      <i class="fas fa-envelope"></i>
    </a>
  </div>
</footer>
  </main>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-96105732-1', 'auto');
    ga('send', 'pageview');
  </script>
  <link rel="stylesheet" href="/personal_site/css/katex.min.css">
  <script defer src="/personal_site/js/katex.min.js"></script>
  <script defer src="/personal_site/js/mathtex-script-type.min.js"></script>
  <script src="https://kit.fontawesome.com/fa2f0e5568.js" crossorigin="anonymous"></script>
</body>
</html>

