<!DOCTYPE html>
<html lang="en" >
<link rel="stylesheet" href="https://kipp.ly/themes/purple.css">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="no-referrer">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>Tensorflow with Go Code Examples: TFRecord Examples, TF Serving Clients | kipply&#x27;s blog</title>
<meta property="og:title" content="Tensorflow with Go Code Examples: TFRecord Examples, TF Serving Clients | kipply&#x27;s blog" />
<meta name="twitter:title" content="Tensorflow with Go Code Examples: TFRecord Examples, TF Serving Clients | kipply&#x27;s blog" />

  <meta name="description" content="kipply&#x27;s blog about stuff she does or reads about or observes">
  <meta property="og:description" content="kipply&#x27;s blog about stuff she does or reads about or observes">
  <meta name="twitter:description" content="kipply&#x27;s blog about stuff she does or reads about or observes">

  <meta property="og:site_name" content="kipply&#x27;s blog" />
  <meta property="og:url" content="https:&#x2F;&#x2F;kipp.ly" />

  <link
      rel="preload"
      href="https://fonts.cdnfonts.com/css/linux-libertine-o"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
  />
  <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
  />
  <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Rubik&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
  />
  <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
      <link
          href="https://fonts.cdnfonts.com/css/linux-libertine-o"
          rel="stylesheet"
          type="text/css"
      />
      <link
          href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap"
          rel="stylesheet"
          type="text/css"
      />
      <link
          href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Rubik&display=swap"
          rel="stylesheet"
          type="text/css"
      />
      <link
          href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600&display=swap"
          rel="stylesheet"
          type="text/css"
      />
  </noscript>

  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">

  <script type="text/javascript">
  let fetchStyle = function() {
        const themes = ['blue', 'deeppurple', 'green', 'lightblue', 'pink', 'purple', 'red'];
    const theme = "https://kipp.ly/themes/" + themes[Math.floor(Math.random() * themes.length)] + ".css";

    let link = document.createElement('link');
    link.type = 'text/css';
    link.rel = 'stylesheet';
    link.onload = function() {
      document.documentElement.setAttribute("style", "display:auto");
     };
    link.href = theme;

    let headScript = document.querySelector('script');
    headScript.parentNode.insertBefore(link, headScript);
  }
  fetchStyle()
  </script>

  <link rel='icon' type='image/x-icon' href="https://kipp.ly/favicon.ico" />

  <link rel="alternate" type="application/atom+xml" title="kipply&#x27;s blog" href="https://kipp.ly/atom.xml">

  

</head>
<body>
  <header class="header">
    <h1 class="title-link"><a href="https:&#x2F;&#x2F;kipp.ly">kipply&#x27;s blog</a></h1>
    <div class="header-links">
      <a href="https://twitter.com/kipperrii">twitter</a>,
      your_name at kipp dot ly
    </div>
  </header>

  <main id="main" class="main">
    



<header class="">
  <h1>Tensorflow with Go Code Examples: TFRecord Examples, TF Serving Clients</h1>
  <div>
    <div class="article-meta">
      <time datetime="2021-03-06">
        2021-03-06
      </time>
      
      (6 min read)
    </div>
  </div>
</header>
<article class="article ">
  <div class="page-body">
    <!--  -->
    <section id="js-article" class="article-body">
      
<blockquote>
<p>All code examples can be found in <a href="https://github.com/kipply/tf-go-examples">this repo</a>. If you know what you're looking for, and the code works out of the box for you, the following post will be pretty useless.</p>
</blockquote>
<p>Tensorflow doesn't yet have support for TFRecords or TF Serving clients. This is not a package because TFRecord read/write and gRPC TFServing client are no more than a hundred lines each, and I don't want to maintain it.</p>
<p>Reference Links: <a href="https://grpc.io/">gRPC</a> || <a href="https://developers.google.com/protocol-buffers/docs/gotutorial">Proto Buffers Go</a> || <a href="https://www.tensorflow.org/tfx/serving/serving_basic">Tensorflow Serving</a> || <a href="https://www.tensorflow.org/tutorials/load_data/tfrecord">TFRecords and tf.Train.Example</a></p>
<h3 id="compiling-protos">Compiling Protos</h3>
<p>To generate the Go files:</p>
<ul>
<li>Clone the TF Serving and Tensorflow repositories</li>
<li>Checkout to the version you need</li>
<li>Run <a href="https://github.com/kipply/tf-go-examples/blob/master/compile.sh">this script</a> after replacing the <code>PATH_TO_TF</code> and <code>PATH_TO_TF_SERVING</code> variables with your path.</li>
</ul>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#ff79c6;">=</span><span style="color:#f1fa8c;">/Users/kipply/code/tensorflow/
</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#ff79c6;">=</span><span style="color:#f1fa8c;">/Users/kipply/code/tfserving/
</span><span>
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;">/tensorflow_serving/apis/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;">/tensorflow_serving/config/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;">/tensorflow_serving/util/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;">/tensorflow_serving/core/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;">/tensorflow_serving/sources/storage_path/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;">/tensorflow/core/framework/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;">/tensorflow/core/example/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;">/tensorflow/core/lib/core/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;">/tensorflow/core/protobuf/*.proto&quot;
</span><span style="color:#8be9fd;">eval </span><span style="color:#f1fa8c;">&quot;protoc -I $</span><span style="color:#ffffff;">PATH_TO_TF_SERVING</span><span style="color:#f1fa8c;"> -I $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;"> --go_out=plugins=grpc:src/ $</span><span style="color:#ffffff;">PATH_TO_TF</span><span style="color:#f1fa8c;">/tensorflow/stream_executor/*.proto&quot;
</span><span>
</span><span style="color:#50fa7b;">rm</span><span> src/tensorflow_serving/apis/prediction_log.pb.go </span><span style="color:#6272a4;"># causes an import loop
</span></code></pre>
<p>I also commited the compilation <a href="https://github.com/kipply/tf-go-examples/tree/master/src">here</a>, though I can't guarantee the version. I recommend that the compiled files be placed in the gopath, or the package name can be find+replaced and you can commit the <code>pb.go</code> files to your repository.</p>
<p>The script compiles more packages than is absolutely necessary for TFServing+TFRecord writing. The import loop is that <code>tensorflow_serving/prediction_log</code> imports <code>tensorflow_serving/core</code> which imports <code>tensorflow_serving/apis</code>. It's a logically valid import cycle of the structs and functions, but Golang won't allow package import cycles. If you need <code>prediction_log</code> protos, you can manually move <code>/core</code> into <code>/apis</code>.</p>
<h3 id="tf-serving-client-over-grpc">TF Serving Client over GRPC</h3>
<p>A link to a executable script <a href="https://github.com/kipply/tf-go-examples/blob/master/client.go">here</a>. <code>cd</code> into the repository directory and execute with:</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>export GOPATH=$GOPATH:$PWD &amp;&amp; go run client.go
</span></code></pre>
<p>If no TF Serving Server is running at <code>localhost:9000</code>, then you'll get the following error;</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>rpc error: code = Unavailable desc = connection error: desc = &quot;transport: Error while dialing dial tcp [::1]:9000: connect: connection refused&quot;
</span></code></pre>
<p>Here's a snippet of the script that fetches the model metadata, given the name of the model. In production, you should use a connection pool.</p>
<pre data-lang="go" style="background-color:#282a36;color:#f8f8f2;" class="language-go "><code class="language-go" data-lang="go"><span>modelURL </span><span style="color:#ff79c6;">:= </span><span style="color:#f1fa8c;">&quot;localhost:9000&quot;
</span><span>modelMetadataRequest </span><span style="color:#ff79c6;">:= &amp;</span><span style="color:#ffffff;">tfServing</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">GetModelMetadataRequest</span><span>{
</span><span>  </span><span style="color:#ffffff;">ModelSpec</span><span>: </span><span style="color:#ff79c6;">&amp;</span><span style="color:#ffffff;">tfServing</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">ModelSpec</span><span>{
</span><span>    </span><span style="color:#ffffff;">Name</span><span>: </span><span style="color:#f1fa8c;">&quot;model&quot;</span><span>,
</span><span>  },
</span><span>  </span><span style="color:#ffffff;">MetadataField</span><span>: []</span><span style="font-style:italic;color:#66d9ef;">string</span><span>{</span><span style="color:#f1fa8c;">&quot;signature_def&quot;</span><span>},
</span><span>}
</span><span>
</span><span>conn, err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">grpc</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Dial</span><span>(</span><span style="color:#ffffff;">modelURL</span><span>, </span><span style="color:#ffffff;">grpc</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">WithInsecure</span><span>())
</span><span style="color:#ff79c6;">if </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>  </span><span style="color:#ffffff;">log</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Fatalf</span><span>(</span><span style="color:#ffffff;">err</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Error</span><span>())
</span><span>}
</span><span>
</span><span>client </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">tfServing</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">NewPredictionServiceClient</span><span>(</span><span style="color:#ffffff;">conn</span><span>)
</span><span>
</span><span>metadata, err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">client</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">GetModelMetadata</span><span>(</span><span style="color:#ffffff;">context</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Background</span><span>(), </span><span style="color:#ffffff;">modelMetadataRequest</span><span>)
</span><span style="color:#ff79c6;">if </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>  </span><span style="color:#ffffff;">log</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Fatalf</span><span>(</span><span style="color:#ffffff;">err</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Error</span><span>())
</span><span>}
</span><span style="color:#ffffff;">fmt</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Println</span><span>(</span><span style="color:#ffffff;">metadata</span><span>)
</span></code></pre>
<p>A thing about gRPC over Go is that you always send slices. If you want to send a 2D slice of integers, you need to flatten the slice and specify the dimensions in the request, and gRPC will validate that a slice of the correct length was sent. <a href="https://github.com/kipply/tf-go-examples/blob/master/client.go#L48">A link to the script again</a>, and two functions to copypasta:</p>
<pre data-lang="go" style="background-color:#282a36;color:#f8f8f2;" class="language-go "><code class="language-go" data-lang="go"><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">int64Flatten</span><span>(</span><span style="font-style:italic;color:#ffb86c;">slisli </span><span>[][]</span><span style="font-style:italic;color:#66d9ef;">int64</span><span>) []</span><span style="font-style:italic;color:#66d9ef;">int64 </span><span>{
</span><span>	flattened </span><span style="color:#ff79c6;">:= </span><span>[]</span><span style="font-style:italic;color:#66d9ef;">int64</span><span>{}
</span><span>	</span><span style="color:#ff79c6;">for </span><span style="color:#bd93f9;">_</span><span>, sli </span><span style="color:#ff79c6;">:= range </span><span style="color:#ffffff;">slisli </span><span>{
</span><span>		</span><span style="color:#ffffff;">flattened </span><span style="color:#ff79c6;">= </span><span style="color:#8be9fd;">append</span><span>(</span><span style="color:#ffffff;">flattened</span><span>, </span><span style="color:#ffffff;">sli</span><span style="color:#ff79c6;">...</span><span>)
</span><span>	}
</span><span>	</span><span style="color:#ff79c6;">return </span><span style="color:#ffffff;">flattened
</span><span>}
</span><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">int32Flatten</span><span>(</span><span style="font-style:italic;color:#ffb86c;">slisli </span><span>[][]</span><span style="font-style:italic;color:#66d9ef;">int32</span><span>) []</span><span style="font-style:italic;color:#66d9ef;">int32 </span><span>{
</span><span>	flattened </span><span style="color:#ff79c6;">:= </span><span>[]</span><span style="font-style:italic;color:#66d9ef;">int32</span><span>{}
</span><span>	</span><span style="color:#ff79c6;">for </span><span style="color:#bd93f9;">_</span><span>, sli </span><span style="color:#ff79c6;">:= range </span><span style="color:#ffffff;">slisli </span><span>{
</span><span>		</span><span style="color:#ffffff;">flattened </span><span style="color:#ff79c6;">= </span><span style="color:#8be9fd;">append</span><span>(</span><span style="color:#ffffff;">flattened</span><span>, </span><span style="color:#ffffff;">sli</span><span style="color:#ff79c6;">...</span><span>)
</span><span>	}
</span><span>	</span><span style="color:#ff79c6;">return </span><span style="color:#ffffff;">flattened
</span><span>}
</span></code></pre>
<h3 id="tfrecord-example-read-write">TFRecord Example Read+Write</h3>
<p>Link to executable script <a href="https://github.com/kipply/tf-go-examples/blob/master/tfrecords.go">here</a>. <code>cd</code> into the directory and execute with:</p>
<pre data-lang="bash" style="background-color:#282a36;color:#f8f8f2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#50fa7b;">go</span><span> run tfrecords.go
</span></code></pre>
<p>The output should be;</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>[1 2 3 4 5] hello [0.1 0.2 0.3 0.4 0.5]
</span></code></pre>
<p>Here is the part of the script that's needed for read+write!</p>
<pre data-lang="go" style="background-color:#282a36;color:#f8f8f2;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#6272a4;">// https://github.com/tensorflow/tensorflow/blob/051a96f3ec4fc38b248e8ae8ad2f8ad124eda59b/tensorflow/core/lib/hash/crc32c.h
</span><span style="font-style:italic;color:#8be9fd;">const </span><span style="color:#ffffff;">maskDelta </span><span style="font-style:italic;color:#66d9ef;">uint32 </span><span style="color:#ff79c6;">= </span><span style="color:#bd93f9;">0xa282ead8
</span><span>
</span><span style="color:#6272a4;">// https://github.com/tensorflow/tensorflow/blob/051a96f3ec4fc38b248e8ae8ad2f8ad124eda59b/tensorflow/core/lib/hash/crc32c.h#L53-L56
</span><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">mask</span><span>(</span><span style="font-style:italic;color:#ffb86c;">crc </span><span style="font-style:italic;color:#66d9ef;">uint32</span><span>) </span><span style="font-style:italic;color:#66d9ef;">uint32 </span><span>{
</span><span>	</span><span style="color:#ff79c6;">return </span><span>((</span><span style="color:#ffffff;">crc </span><span style="color:#ff79c6;">&gt;&gt; </span><span style="color:#bd93f9;">15</span><span>) </span><span style="color:#ff79c6;">| </span><span>(</span><span style="color:#ffffff;">crc </span><span style="color:#ff79c6;">&lt;&lt; </span><span style="color:#bd93f9;">17</span><span>)) </span><span style="color:#ff79c6;">+ </span><span style="color:#ffffff;">maskDelta
</span><span>}
</span><span>
</span><span style="font-style:italic;color:#8be9fd;">var </span><span>crc32Table </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">crc32</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">MakeTable</span><span>(</span><span style="color:#ffffff;">crc32</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">Castagnoli</span><span>)
</span><span>
</span><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">crc32Hash</span><span>(</span><span style="font-style:italic;color:#ffb86c;">data </span><span>[]</span><span style="font-style:italic;color:#66d9ef;">byte</span><span>) </span><span style="font-style:italic;color:#66d9ef;">uint32 </span><span>{
</span><span>	</span><span style="color:#ff79c6;">return </span><span style="color:#ffffff;">crc32</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Checksum</span><span>(</span><span style="color:#ffffff;">data</span><span>, </span><span style="color:#ffffff;">crc32Table</span><span>)
</span><span>}
</span><span>
</span><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">uint64ToBytes</span><span>(</span><span style="font-style:italic;color:#ffb86c;">x </span><span style="font-style:italic;color:#66d9ef;">uint64</span><span>) []</span><span style="font-style:italic;color:#66d9ef;">byte </span><span>{
</span><span>	b </span><span style="color:#ff79c6;">:= </span><span style="color:#8be9fd;">make</span><span>([]</span><span style="font-style:italic;color:#66d9ef;">byte</span><span>, </span><span style="color:#bd93f9;">8</span><span>)
</span><span>	</span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">PutUint64</span><span>(</span><span style="color:#ffffff;">b</span><span>, </span><span style="color:#ffffff;">x</span><span>)
</span><span>	</span><span style="color:#ff79c6;">return </span><span style="color:#ffffff;">b
</span><span>}
</span><span>
</span><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">Write</span><span>(</span><span style="font-style:italic;color:#ffb86c;">w </span><span style="color:#ffffff;">io</span><span style="color:#ff79c6;">.</span><span style="font-style:italic;color:#8be9fd;">Writer</span><span>, </span><span style="font-style:italic;color:#ffb86c;">data </span><span>[]</span><span style="font-style:italic;color:#66d9ef;">byte</span><span>) (</span><span style="font-style:italic;color:#66d9ef;">int</span><span>, </span><span style="font-style:italic;color:#66d9ef;">error</span><span>) {
</span><span>	</span><span style="color:#6272a4;">// Write based on format specified in https://github.com/tensorflow/tensorflow/blob/051a96f3ec4fc38b248e8ae8ad2f8ad124eda59b/tensorflow/core/lib/io/record_writer.cc#L124-L128
</span><span>	</span><span style="color:#6272a4;">//  uint64    length
</span><span>	</span><span style="color:#6272a4;">//  uint32    masked crc of length
</span><span>	</span><span style="color:#6272a4;">//  byte      data[length]
</span><span>	</span><span style="color:#6272a4;">//  uint32    masked crc of data
</span><span>
</span><span>	length </span><span style="color:#ff79c6;">:= </span><span style="font-style:italic;color:#66d9ef;">uint64</span><span>(</span><span style="color:#8be9fd;">len</span><span>(</span><span style="color:#ffffff;">data</span><span>))
</span><span>	lengthCRC </span><span style="color:#ff79c6;">:= </span><span style="color:#50fa7b;">mask</span><span>(</span><span style="color:#50fa7b;">crc32Hash</span><span>(</span><span style="color:#50fa7b;">uint64ToBytes</span><span>(</span><span style="font-style:italic;color:#66d9ef;">uint64</span><span>(</span><span style="color:#8be9fd;">len</span><span>(</span><span style="color:#ffffff;">data</span><span>)))))
</span><span>	dataCRC </span><span style="color:#ff79c6;">:= </span><span style="color:#50fa7b;">mask</span><span>(</span><span style="color:#50fa7b;">crc32Hash</span><span>(</span><span style="color:#ffffff;">data</span><span>))
</span><span>
</span><span>	</span><span style="color:#ff79c6;">if </span><span>err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Write</span><span>(</span><span style="color:#ffffff;">w</span><span>, </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span>, </span><span style="color:#ffffff;">length</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">0</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#ff79c6;">if </span><span>err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Write</span><span>(</span><span style="color:#ffffff;">w</span><span>, </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span>, </span><span style="color:#ffffff;">lengthCRC</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">0</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#ff79c6;">if </span><span style="color:#bd93f9;">_</span><span>, err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">w</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Write</span><span>(</span><span style="color:#ffffff;">data</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">0</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#ff79c6;">if </span><span>err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Write</span><span>(</span><span style="color:#ffffff;">w</span><span>, </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span>, </span><span style="color:#ffffff;">dataCRC</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">0</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#ff79c6;">return </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Size</span><span>(</span><span style="color:#ffffff;">dataCRC</span><span>) </span><span style="color:#ff79c6;">+ </span><span style="color:#8be9fd;">len</span><span>(</span><span style="color:#ffffff;">data</span><span>) </span><span style="color:#ff79c6;">+ </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Size</span><span>(</span><span style="color:#ffffff;">length</span><span>) </span><span style="color:#ff79c6;">+ </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Size</span><span>(</span><span style="color:#ffffff;">lengthCRC</span><span>), </span><span style="color:#bd93f9;">nil
</span><span>}
</span><span>
</span><span style="font-style:italic;color:#8be9fd;">func </span><span style="color:#50fa7b;">Read</span><span>(</span><span style="font-style:italic;color:#ffb86c;">r </span><span style="color:#ffffff;">io</span><span style="color:#ff79c6;">.</span><span style="font-style:italic;color:#8be9fd;">Reader</span><span>) (</span><span style="font-style:italic;color:#ffb86c;">data </span><span>[]</span><span style="font-style:italic;color:#66d9ef;">byte</span><span>, </span><span style="font-style:italic;color:#ffb86c;">err </span><span style="font-style:italic;color:#66d9ef;">error</span><span>) {
</span><span>	</span><span style="font-style:italic;color:#8be9fd;">var </span><span>(
</span><span>		length         </span><span style="font-style:italic;color:#66d9ef;">uint64
</span><span>		lengthChecksum </span><span style="font-style:italic;color:#66d9ef;">uint32
</span><span>		dataChecksum   </span><span style="font-style:italic;color:#66d9ef;">uint32
</span><span>	)
</span><span>
</span><span>	</span><span style="color:#6272a4;">// get data length
</span><span>	</span><span style="color:#ff79c6;">if </span><span>err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Read</span><span>(</span><span style="color:#ffffff;">r</span><span>, </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span>, </span><span style="color:#ff79c6;">&amp;</span><span style="color:#ffffff;">length</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">nil</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#6272a4;">// get length checksum
</span><span>	</span><span style="color:#ff79c6;">if </span><span>err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Read</span><span>(</span><span style="color:#ffffff;">r</span><span>, </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span>, </span><span style="color:#ff79c6;">&amp;</span><span style="color:#ffffff;">lengthChecksum</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">nil</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#6272a4;">// get data
</span><span>	</span><span style="color:#ffffff;">data </span><span style="color:#ff79c6;">= </span><span style="color:#8be9fd;">make</span><span>([]</span><span style="font-style:italic;color:#66d9ef;">byte</span><span>, </span><span style="color:#ffffff;">length</span><span>)
</span><span>	</span><span style="color:#ff79c6;">if </span><span style="color:#bd93f9;">_</span><span>, err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">r</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Read</span><span>(</span><span style="color:#ffffff;">data</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">nil</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#6272a4;">// get data checksum
</span><span>	</span><span style="color:#ff79c6;">if </span><span>err </span><span style="color:#ff79c6;">:= </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Read</span><span>(</span><span style="color:#ffffff;">r</span><span>, </span><span style="color:#ffffff;">binary</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">LittleEndian</span><span>, </span><span style="color:#ff79c6;">&amp;</span><span style="color:#ffffff;">dataChecksum</span><span>); </span><span style="color:#ffffff;">err </span><span style="color:#ff79c6;">!= </span><span style="color:#bd93f9;">nil </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">nil</span><span>, </span><span style="color:#ffffff;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#6272a4;">// check checksum length
</span><span>	</span><span style="color:#ff79c6;">if </span><span>actual </span><span style="color:#ff79c6;">:= </span><span style="color:#50fa7b;">mask</span><span>(</span><span style="color:#50fa7b;">crc32Hash</span><span>(</span><span style="color:#50fa7b;">uint64ToBytes</span><span>(</span><span style="color:#ffffff;">length</span><span>))); </span><span style="color:#ffffff;">actual </span><span style="color:#ff79c6;">!= </span><span style="color:#ffffff;">lengthChecksum </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">nil</span><span>, </span><span style="color:#ffffff;">errors</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">New</span><span>(</span><span style="color:#f1fa8c;">&quot;corrupted record, length checksum doesn&#39;t match&quot;</span><span>)
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#6272a4;">// check data checksum
</span><span>	</span><span style="color:#ff79c6;">if </span><span>actual </span><span style="color:#ff79c6;">:= </span><span style="color:#50fa7b;">mask</span><span>(</span><span style="color:#50fa7b;">crc32Hash</span><span>(</span><span style="color:#ffffff;">data</span><span>)); </span><span style="color:#ffffff;">actual </span><span style="color:#ff79c6;">!= </span><span style="color:#ffffff;">dataChecksum </span><span>{
</span><span>		</span><span style="color:#ff79c6;">return </span><span style="color:#bd93f9;">nil</span><span>, </span><span style="color:#ffffff;">errors</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">New</span><span>(</span><span style="color:#f1fa8c;">&quot;corrupted record, data checksum doesn&#39;t match&quot;</span><span>)
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#ff79c6;">return </span><span style="color:#ffffff;">data</span><span>, </span><span style="color:#bd93f9;">nil
</span><span>}
</span></code></pre>
<p>The code that writes tf.Train.Examples is <a href="https://github.com/kipply/tf-go-examples/blob/master/tfrecords.go">here</a>, and uses the Example proto compiled in the previous step.</p>
<hr />
<p>I'd like this to be good for Sea Eel Orbit, so in this post you have learned how to read and write Tensorflow Records in Golang and how to communicate with a Tensorflow Serving gRPC server with Golang. It also includes compiling Tensorflow and Tensorflow Serving protobufs.</p>


    </section>
  </div>
</article>


<footer>
  <hr>
    <h1 class="title-link"><a href="https:&#x2F;&#x2F;kipp.ly">kipply&#x27;s blog</a></h1>
    <div class="header-links">
      <a href="https://twitter.com/kipperrii">twitter</a>,
      <a href="mailto:email@kipp.ly">email </a>
    </div>
</footer>
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1afaa6bb0295489fa7a15cd4b46fe09c"}'></script><!-- End Cloudflare Web Analytics -->
  </main>
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1afaa6bb0295489fa7a15cd4b46fe09c"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>

